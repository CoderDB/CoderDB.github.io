---
layout: post
date: 2016-12-29
title: Runtime
feature-img: "img/blue.jpg"

---

<h2>ä¸€ã€ Runtimeç®€ä»‹</h2>
---
Objective-Cæ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥é™¤äº†éœ€è¦ç¼–è¯‘å™¨ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿï¼ˆruntime systemï¼‰ï¼Œç›®çš„æ˜¯å°†ä¸€äº›å·¥ä½œä»ç¼–è¯‘ç¯èŠ‚æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ã€‚Runtimeç®€ç§°è¿è¡Œæ—¶ã€‚
[æ›´è¿‡å…³äºRuntimeçš„ä»‹ç»](https://developer.apple.com/reference/objectivec/1657527-objective_c_runtime)

<h2>äºŒã€ è®¤è¯†Runtime</h2>
---
è¦è®¤è¯†Runtimeå°±è¦ä»Runtimeç›¸å…³çš„å¤´æ–‡ä»¶è¯´èµ·ï¼Œåœ¨[è¿™é‡Œ](https://opensource.apple.com/source/objc4/objc4-217/runtime/)å¯ä»¥ä¸‹è½½åˆ°runtimeç›¸å…³çš„å¤´æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ğŸ‘‡è·¯å¾„æ‰¾å¾—åˆ°
{% highlight ruby %}
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk/usr/include/objc
{% endhighlight %}
çœ‹èµ·æ¥åƒè¿™æ ·

![runtime](http://ogkg37m8j.bkt.clouddn.com/image/runtime/runtime.jpg)

å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯runtime.hå’Œmessage.h ã€‚ä¸‹é¢åˆ†åˆ«è¯´æ˜
<h3>1. runtime.h</h3>
{% highlight swift %}
#ifndef _OBJC_RUNTIME_H
#define _OBJC_RUNTIME_H

#include <objc/objc.h>
#include <stdarg.h>
#include <stdint.h>
#include <stddef.h>
#include <Availability.h>
#include <TargetConditionals.h>

#if TARGET_OS_MAC
#include <sys/types.h>
#endif
{% endhighlight %}
è¿™æ˜¯runtime.hæ–‡ä»¶çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œå¼•å…¥äº†ä¸€äº›å…¶ä»–å¤´æ–‡ä»¶ï¼Œè¿™é‡Œç®€å•è¯´é¢ä¸€ä¸‹ **ifndef** ï¼Œå®ƒæ˜¯ **if not defined** çš„ç®€å†™ï¼Œç›®çš„æ˜¯ä¿è¯åŒä¸€ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åŒ…å«å¤šæ¬¡ã€‚æ¥ä¸‹æ¥çš„ç¬¬äºŒéƒ¨åˆ†å®šä¹‰äº†ä¸€äº›ç±»å‹
{% highlight swift %}/* Types */

#if !OBJC_TYPES_DEFINED

/// An opaque type that represents a method in a class definition.
typedef struct objc_method *Method;

/// An opaque type that represents an instance variable.
typedef struct objc_ivar *Ivar;

/// An opaque type that represents a category.
typedef struct objc_category *Category;

/// An opaque type that represents an Objective-C declared property.
typedef struct objc_property *objc_property_t;

struct objc_class {
    Class isa  OBJC_ISA_AVAILABILITY;

#if !__OBJC2__
    Class super_class                                        OBJC2_UNAVAILABLE;
    const char *name                                         OBJC2_UNAVAILABLE;
    long version                                             OBJC2_UNAVAILABLE;
    long info                                                OBJC2_UNAVAILABLE;
    long instance_size                                       OBJC2_UNAVAILABLE;
    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;
    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;
    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;
    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;
#endif

} OBJC2_UNAVAILABLE;
#endif
{% endhighlight %}
åœ¨è¿™ä¸€éƒ¨åˆ†æœ‰å¿…è¦è¯´æ˜ä¸¤éƒ¨åˆ†ï¼Œä¸€æ˜¯ **typedef struct objc_method *Method** ï¼ŒäºŒæ˜¯ **OBJC2_UNAVAILABLE** ã€‚
{% highlight swift %}
typedef struct objc_method *Method;

// å®šä¹‰äº†ä¸€ä¸ª Method çš„ç±»å‹ï¼ŒMethod å…¶å®æ˜¯ struct objc_method * ç»“æ„ä½“æŒ‡é’ˆçš„åˆ«å
{% endhighlight %}
è€Œè‡³äº **OBJC2_UNAVAILABLE** å°±æœ‰ç‚¹å¥‡æ€ªäº†ï¼
{% highlight swift %}
struct objc_class {
  // ...
} OBJC2_UNAVAILABLE;
{% endhighlight %}
é¦–å…ˆæŠ›å»å…¶ä»–çš„ä¸ç®¡ï¼Œå…ˆæ˜¯å£°æ˜äº†ä¸€ä¸ªåä¸º **objc_class** çš„ç»“æ„ä½“ï¼Œå¹¶å£°æ˜ä¸€ä¸ª **OBJC2_UNAVAILABLE** çš„ç»“æ„ä½“å˜é‡ã€‚å†çœ‹ğŸ‘‡ç›¸å¯¹ç®€å•çš„è¿™è¡Œ
{% highlight swift %}
long version                                             OBJC2_UNAVAILABLE;
{% endhighlight %}
è¿™æ˜¯ä»€ä¹ˆæ„æ€äº†ï¼Ÿå£°æ˜ä¸€ä¸ª **long** ç±»å‹çš„ **version** å˜é‡ï¼Ÿä¸ºä»€ä¹ˆåé¢åŠ äº†ä¸€ä¸ª **å˜é‡** ï¼Ÿ**[ç»“æ„ä½“è‡ªå¼•ç”¨]()** ï¼Ÿå¯¹æ­¤æˆ‘ä¸“é—¨åšäº†ä¸€äº›æµ‹è¯•ï¼š
{% highlight swift %}
// 1. å®šä¹‰ä¸€ä¸ªStudentç»“æ„ä½“ï¼Œå£°æ˜ä¸€ä¸ªcollageå˜é‡
struct Student {
  int age;
} collage;

// 2. ç›´æ¥å°†collageå˜é‡å åœ¨å£°æ˜çš„ageåé¢ï¼Œcommand + b
struct Student {
  int age collage;
} collage;
// æ­¤æ—¶ç¼–è¯‘ä¸é€šè¿‡

// 3. é‚£å°±æ¨¡ä»¿çš„æ›´åƒä¸€ç‚¹ï¼Œä¹Ÿå®šä¹‰ä¸€ä¸ªå®
#include <stdio.h>
#define TEST true
int main(int argc, char *argv[]) {
  struct Student {
    #if TEST
    int age collage;
    #endif
  } collage;
}
// è¿™æ—¶ç¼–è¯‘æ˜¯æ²¡é—®é¢˜çš„
{% endhighlight %}
æ¥ä¸‹æ¥æ˜¯ç¬¬ä¸‰éƒ¨åˆ†
{% highlight swift %}
#ifdef __OBJC__
@class Protocol;
#else
typedef struct objc_object Protocol;
#endif
{% endhighlight %}
è¿™éƒ¨åˆ†ä¸€ç›®äº†ç„¶ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œå†çœ‹ç¬¬å››éƒ¨åˆ†
{% highlight swift %}
struct objc_method_description {
	SEL name;               /**< The name of the method */
	char *types;            /**< The types of the method arguments */
};

/// Defines a property attribute
typedef struct {
    const char *name;           /**< The name of the attribute */
    const char *value;          /**< The value of the attribute (usually empty) */
} objc_property_attribute_t;
{% endhighlight %}
å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“ã€‚ä¹‹åå°±æ˜¯ **Runtime**æœ€ä¸ºé‡è¦çš„éƒ¨åˆ†ï¼Œå®šä¹‰äº†æ‰€æœ‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°åœ¨æ­¤ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œä½†æ˜¯éœ€è¦è¡¥å……çš„æ˜¯ä¸€äº›è§„åˆ™ï¼Œäº†è§£è¿™äº›è§„åˆ™å¯ä»¥æ›´å¥½çš„ç†Ÿæ‚‰ **Runtime**

* å¯¹å¯¹è±¡è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **object_** å¼€å¤´
* å¯¹ç±»è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **class_** å¼€å¤´
* å¯¹ç±»æˆ–å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **method_** å¼€å¤´
* å¯¹æˆå‘˜å˜é‡è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **ivar_** å¼€å¤´
* å¯¹å±æ€§è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **property_** å¼€å¤´å¼€å¤´
* å¯¹åè®®è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä¸€èˆ¬ä»¥ **protocol_** å¼€å¤´

<h3>2. message.h</h3>
